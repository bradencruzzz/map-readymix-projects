# Isochrone Centering Fix

## Problem
Isochrones generated by the TravelTime API are not centered on the requested location marker. The center point is significantly offset from the isochrone polygon (e.g., 32.8km E/W, 7.5km N/S).

## Root Cause
The TravelTime API v4 may return coordinates in different formats:
- **Request format**: `{"lat": float, "lng": float}` ✓ (correct)
- **Response format**: Arrays may be `[lat, lng]` or `[lng, lat]` (unclear from documentation)

The coordinate parsing logic was trying to detect the format using heuristics, but this could fail, causing coordinates to be parsed incorrectly.

## Solution Implemented

### 1. Simplified Coordinate Parsing
**File:** `src/backend/iso_client.py` - `_convert_shell_to_coordinates()` function

**Change:**
- Always parse arrays as `[lng, lat]` initially (GeoJSON standard)
- Removed complex heuristic-based format detection
- Let the swap detection logic handle corrections

**Before:**
```python
# Complex heuristic trying to detect format
if (-90 <= val0 <= 90) and (-180 <= val1 <= 180):
    lat_val = val0  # Assume [lat, lng]
    lng_val = val1
elif (-180 <= val0 <= 180) and (-90 <= val1 <= 90):
    lng_val = val0  # Assume [lng, lat]
    lat_val = val1
```

**After:**
```python
# Always assume GeoJSON standard [lng, lat]
lng_val = _coerce_float(coord[0])
lat_val = _coerce_float(coord[1])
```

### 2. Enhanced Swap Detection
**File:** `src/backend/iso_client.py` - `get_isochrone()` function

**Change:**
- After parsing coordinates, check if center point is within bounds
- If not, try swapping coordinates and check again
- Use swapped coordinates if center is now in bounds
- Added detailed logging for swap detection

**Logic:**
```python
# Check if center is in bounds
center_in_bounds = _bounds_contain_point(bounds, center_lng, center_lat)

# If not, try swapping coordinates
if not center_in_bounds:
    swapped_coords = [[c[1], c[0]] for c in coords]  # Swap lat/lng
    swapped_bounds = _compute_bounds(swapped_coords)
    swapped_center_in_bounds = _bounds_contain_point(swapped_bounds, center_lng, center_lat)
    
    if swapped_center_in_bounds:
        # Use swapped coordinates
        coords = swapped_coords
        bounds = swapped_bounds
```

### 3. Improved Logging
**File:** `src/backend/iso_client.py`

**Changes:**
- Added detailed logging of API request body
- Log when coordinates are swapped
- Log bounds before and after swapping
- Better visibility into coordinate parsing process

## Testing

### Expected Behavior After Fix:
1. **Isochrones should be centered** on the requested location marker
2. **Center point should be within** the isochrone polygon
3. **No offset warnings** should appear in logs (or minimal offset < 1km)
4. **Swap detection logs** should show if coordinates were swapped

### How to Verify:
1. Search for a location (e.g., "5700 Lake Wright")
2. Click the marker and generate a 30-minute isochrone
3. **Expected**: Isochrone polygon should be centered on the marker
4. Check server logs for:
   - `"[Isochrone] ✓ Coordinates were swapped!"` (if swap was needed)
   - `"Center point is within the isochrone polygon ✓"` (success message)
   - No large offset warnings

## Files Modified

1. `src/backend/iso_client.py`
   - `_convert_shell_to_coordinates()` - Simplified coordinate parsing
   - `get_isochrone()` - Enhanced swap detection with better logging

## Status

✅ **Fix implemented and server restarted**

The isochrone centering issue should now be resolved. The coordinate swap detection will automatically correct any coordinate order issues from the TravelTime API response.

**Note:** The server has been restarted with the fixes. Test by generating an isochrone and verifying it's centered on the marker.

